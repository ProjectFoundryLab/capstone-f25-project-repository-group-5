<!--
  NOTE FOR JACOB (Backend Integration Required)
  ---------------------------------------------

  WHAT THIS PAGE DOES (FRONTEND):
  • Fully built Patients UI with:
      - Search bar
      - Status filter (Admitted, Discharged)
      - Admit reason filter (COVID-19, Flu, etc.)
      - Table that displays patient info
  • All rendering, filtering, and UI logic on the frontend is DONE.
  • Page is ready to plug into backend data immediately.

  WHAT'S NEEDED FROM BACKEND:
  • Create a Cloud Run endpoint:
        GET /patients
    Example:
        https://ingest-service-725327609427.us-east5.run.app/patients

  • This route should return JSON converted from patients.csv 
    stored in the bucket: hospital-data-ingest

  • Expected JSON array format (one object per patient):
      {
        "patient_id": <int>,
        "first_name": "Olivia",
        "last_name": "Wilson",
        "medical_record_number": "MRN1000",
        "admission_status": "Admitted" or "Discharged",
        "priority_level": <number>,
        "admit_reason": "COVID-19" or other string
      }

  • The frontend reads this JSON directly and populates the table.

  FILES IN GCP:
  • patients.csv located in bucket: hospital-data-ingest
  • Backend should load patients.csv → convert → return via /patients

  ACTION JACOB NEEDS TO COMPLETE:
  1. Implement GET /patients route in Cloud Run service.
  2. Read patients.csv (or database if you are loading it there).
  3. Convert CSV rows → JSON array in the format above.
  4. Enable CORS for this route (same as /beds).
  5. Return JSON to the frontend.

  Once the /patients endpoint is live, this page will immediately
  display real data with no frontend changes needed.
-->


<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Medbed Systems – Patients</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body class="dashboard-page">
    <!-- ============= SIDEBAR ============= -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <img src="images/Med.jpg" alt="Medbed Systems logo" class="brand-logo" />
          <div class="logo-text">
            <span>Medbed Systems</span>
          </div>
        </div>

        <div class="sidebar-user">
          <div class="avatar-circle">JS</div>
          <div class="user-meta">
            <span class="user-name">John Smith</span>
            <span class="user-role">Doctor</span>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <p class="sidebar-label">Overview</p>
        <a href="dashboard.html">Dashboard</a>
        <a href="insights.html">Insights</a>

        <p class="sidebar-label">Operations</p>
        <a href="patients.html" class="active">Patients</a>
        <a href="manage-beds.html">Manage beds</a>
        <a href="manage-rooms.html">Manage rooms</a>
        <a href="users.html">Users</a>

        <a href="index.html" class="logout-link">Logout</a>
      </nav>
    </aside>

    <!-- ============= MAIN CONTENT ============= -->
    <main class="dashboard-content">
      <header class="topbar">
        <div></div>
        <div class="topbar-pill">
          <span class="pill-label">Today</span>
          <span class="pill-value" id="todayValue">—</span>
        </div>
      </header>

      <section class="page-header">
        <h2>Patients</h2>
        <p class="page-subtitle">
          View current patients, their status, and admission details from the hospital data store.
        </p>
      </section>

      <section class="card patients-card">
        <!-- Filters row -->
        <div class="patients-filters">
          <input
            type="text"
            id="searchInput"
            class="input-text patients-search"
            placeholder="Search by name or MRN"
          />

          <select id="statusFilter" class="input-select">
            <option value="all">All statuses</option>
            <option value="Admitted">Admitted</option>
            <option value="Discharged">Discharged</option>
          </select>

          <select id="reasonFilter" class="input-select">
            <option value="all">All reasons</option>
            <option value="COVID-19">COVID-19</option>
            <option value="Flu">Flu</option>
            <option value="Heart Attack">Heart Attack</option>
            <!-- Add more if you have them in admit_reason -->
          </select>

          <button class="primary-btn" type="button" onclick="applyFilters()">
            Filter
          </button>
        </div>

        <!-- Patients table -->
        <div class="table-wrapper">
          <table class="data-table patients-table">
            <thead>
              <tr>
                <th>Patient</th>
                <th>MRN</th>
                <th>Admission status</th>
                <th>Priority</th>
                <th>Reason</th>
              </tr>
            </thead>
            <tbody id="patientsTableBody">
              <!-- JS will render rows -->
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <!-- ============= PAGE LOGIC ============= -->
    <script>
      const API_BASE = "https://ingest-service-725327609427.us-east5.run.app";

      let ALL_PATIENTS = [];

      function setTodayPatients() {
        const el = document.getElementById("todayValue");
        if (!el) return;
        const now = new Date();
        el.textContent = now.toLocaleString("en-US", {
          month: "short",
          day: "numeric",
        });
      }

      async function loadPatients() {
        try {
          const res = await fetch(`${API_BASE}/patients`);
          if (!res.ok) {
            throw new Error("Failed to load patients");
          }
          const data = await res.json();
          // Expecting data shaped like patients.csv
          ALL_PATIENTS = data || [];
          renderPatientsTable(ALL_PATIENTS);
        } catch (err) {
          console.error("Error loading patients:", err);
          const tbody = document.getElementById("patientsTableBody");
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="empty-row">
                Failed to load patients from backend.
              </td>
            </tr>
          `;
        }
      }

      function statusKeyToClassFromStatus(status) {
        if (!status) return "";
        const s = status.toLowerCase();
        if (s === "admitted") return "status-pill-inuse";
        if (s === "discharged") return "status-pill-discharged";
        return "status-pill-reserved";
      }

      function renderPatientsTable(patients) {
        const tbody = document.getElementById("patientsTableBody");
        tbody.innerHTML = "";

        if (!patients || patients.length === 0) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 5;
          cell.textContent = "No patients match the current filters.";
          cell.className = "empty-row";
          row.appendChild(cell);
          tbody.appendChild(row);
          return;
        }

        patients.forEach((p) => {
          const tr = document.createElement("tr");

          const fullName = `${p.first_name ?? ""} ${p.last_name ?? ""}`.trim() || "Unknown";

          const tdName = document.createElement("td");
          tdName.textContent = fullName;

          const tdMRN = document.createElement("td");
          tdMRN.textContent = p.medical_record_number ?? "—";

          const tdStatus = document.createElement("td");
          const pill = document.createElement("span");
          const statusLabel = p.admission_status ?? "Unknown";
          pill.className = "status-pill " + statusKeyToClassFromStatus(statusLabel);
          pill.textContent = statusLabel;
          tdStatus.appendChild(pill);

          const tdPriority = document.createElement("td");
          tdPriority.textContent = p.priority_level ?? "—";

          const tdReason = document.createElement("td");
          tdReason.textContent = p.admit_reason ?? "—";

          tr.appendChild(tdName);
          tr.appendChild(tdMRN);
          tr.appendChild(tdStatus);
          tr.appendChild(tdPriority);
          tr.appendChild(tdReason);

          tbody.appendChild(tr);
        });
      }

      function applyFilters() {
        const search = document
          .getElementById("searchInput")
          .value.toLowerCase()
          .trim();
        const statusFilter = document.getElementById("statusFilter").value;
        const reasonFilter = document.getElementById("reasonFilter").value;

        const filtered = ALL_PATIENTS.filter((p) => {
          const fullName = `${p.first_name ?? ""} ${p.last_name ?? ""}`
            .toLowerCase()
            .trim();
          const mrn = (p.medical_record_number ?? "").toLowerCase();

          const matchesSearch =
            !search ||
            fullName.includes(search) ||
            mrn.includes(search);

          const status = p.admission_status || "";
          const matchesStatus =
            statusFilter === "all" || status === statusFilter;

          const reason = p.admit_reason || "";
          const matchesReason =
            reasonFilter === "all" || reason === reasonFilter;

          return matchesSearch && matchesStatus && matchesReason;
        });

        renderPatientsTable(filtered);
      }

      window.addEventListener("load", () => {
        setTodayPatients();
        loadPatients();
      });

      document
        .getElementById("searchInput")
        .addEventListener("keyup", (e) => {
          if (e.key === "Enter") {
            applyFilters();
          }
        });
    </script>
  </body>
</html>
