<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Medbed Systems Dashboard</title>

    <!-- shared styles -->
    <link rel="stylesheet" href="../shared/variables.css" />
    <link rel="stylesheet" href="../shared/layout.css" />
    <link rel="stylesheet" href="../shared/components.css" />
    <!-- page-specific -->
    <link rel="stylesheet" href="dashboard.css" />
  </head>

  <body class="dashboard-page">
    <!-- =========================
         SIDEBAR
         ========================= -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <img src="../images/Med.jpg" alt="Medbed Systems logo" class="brand-logo" />
          <div class="logo-text">
            <span>Medbed Systems</span>
          </div>
        </div>

        <div class="sidebar-user">
          <div class="avatar-circle" id="userInitials">JS</div>
          <div class="user-meta">
            <span class="user-name" id="userName">Loading...</span>
            <span class="user-role" id="userRole">Role...</span>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <p class="sidebar-label">Overview</p>
        <a href="dashboard.html" class="active">Dashboard</a>
        <a href="insights.html">Insights</a>

        <p class="sidebar-label">Operations</p>
        <a href="../operations/patients.html">Patients</a>
        <a href="../operations/manage-beds.html">Manage beds</a>
        <a href="../operations/manage-rooms.html">Manage rooms</a>

        <a href="../index.html" class="logout-link">Logout</a>
      </nav>
    </aside>

    <!-- =========================
         MAIN CONTENT
         ========================= -->
    <main class="dashboard-content">
      <header class="topbar">
        <div></div>
        <div class="topbar-pill">
          <span class="pill-label">Today</span>
          <span class="pill-value" id="todayValue">—</span>
        </div>
      </header>

      <section class="page-header">
        <h2>Hospital bed overview</h2>
        <p class="page-subtitle">
          View real-time occupancy across all wards, and update the status of individual beds.
        </p>
      </section>

      <!-- TOP ROW: OCCUPANCY + LOOKER STUDIO ADMISSIONS -->
      <section class="top-row top-row-main">
        <!-- LEFT: OCCUPANCY -->
        <div class="card occupancy-card">
          <h3>Occupancy</h3>

          <p class="big-number">
            <span id="overallOccupancyPercent">—</span><span class="big-number-unit">%</span>
          </p>

          <p class="muted">
            <span id="overallOccupiedBeds">—</span> of
            <span id="overallTotalBeds">—</span> beds in use
          </p>

          <hr class="card-divider" />

          <div class="status-header">Bed status</div>
          <ul class="status-list vertical-status">
            <li>
              <span class="status-label status-available">Available</span>
              <span class="status-value" id="countAvailable">—</span>
            </li>
            <li>
              <span class="status-label status-occupied">Occupied</span>
              <span class="status-value" id="countOccupied">—</span>
            </li>
            <li>
              <span class="status-label status-reserved">Reserved</span>
              <span class="status-value" id="countReserved">—</span>
            </li>
            <li>
              <span class="status-label status-cleaning">Cleaning</span>
              <span class="status-value" id="countCleaning">—</span>
            </li>
            <li>
              <span class="status-label status-transferring">Transferring</span>
              <span class="status-value" id="countTransferring">—</span>
            </li>
          </ul>
        </div>

        <!-- RIGHT: ADMISSIONS CHART -->
        <div class="card chart-card">
          <div class="chart-frame">
            <iframe
              src="https://lookerstudio.google.com/embed/reporting/6e261ff2-c6fa-45c8-8a08-9237021c09ca/page/ZQWgF"
              width="100%"
              height="100%"
              frameborder="0"
              style="border:0;"
              allowfullscreen
              sandbox="allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox">
            </iframe>
          </div>
        </div>
      </section>

      <!-- MIDDLE ROW: 3 WARD CARDS -->
      <section class="page-section">
        <div class="section-header">
          <h3>Wards overview</h3>
          <p class="muted">Current occupancy by ward.</p>
        </div>

        <div class="wards-row">
          <div class="card ward-card">
            <h4 id="ward-1-name">ICU North</h4>
            <p><span id="ward-1-total">—</span> beds</p>
            <p><span id="ward-1-inuse">—</span> in use</p>
            <p><span id="ward-1-available">—</span> available</p>
          </div>

          <div class="card ward-card">
            <h4 id="ward-2-name">General East</h4>
            <p><span id="ward-2-total">—</span> beds</p>
            <p><span id="ward-2-inuse">—</span> in use</p>
            <p><span id="ward-2-available">—</span> available</p>
          </div>

          <div class="card ward-card">
            <h4 id="ward-3-name">Isolation South</h4>
            <p><span id="ward-3-total">—</span> beds</p>
            <p><span id="ward-3-inuse">—</span> in use</p>
            <p><span id="ward-3-available">—</span> available</p>
          </div>
        </div>
      </section>

      <!-- UPDATE BED + DETAILS -->
      <section class="card">
        <h3>Update bed status</h3>
        <p class="muted">
          Choose a bed and update its current status.
        </p>

        <div class="filters-row">
          <select id="bedSelect" class="input-select">
            <option>Loading beds…</option>
          </select>

          <select id="statusSelect" class="input-select">
            <option value="available">Available</option>
            <option value="occupied">Occupied</option>
            <option value="reserved">Reserved</option>
            <option value="cleaning">Cleaning</option>
            <option value="transferring">Transferring</option>
          </select>

          <input
            id="patientIdInput"
            class="input-select"
            placeholder="Patient ID (only required if Occupied)"
            style="max-width:180px;"
          />

          <button class="small-btn" type="button" onclick="updateBed()">Update bed</button>
        </div>
      </section>

      <!-- BOTTOM ROW: DETAILS -->
      <section class="top-row">
        <div class="card">
          <h3>Bed details</h3>
          <div id="bedInfoBox" style="display:none; margin-top: 10px; font-size: 13px;">
            <p id="bedInfoContent"></p>
          </div>
        </div>

        <div class="card">
          <h3>Patient details</h3>
          <div id="patientInfo" style="display:none; margin-top: 10px; font-size: 13px;">
            <p><strong>Patient ID:</strong> <span id="pi_id"></span></p>
            <p><strong>Name:</strong> <span id="pi_name"></span></p>
            <p><strong>Admission status:</strong> <span id="pi_status"></span></p>
            <p><strong>Bed status:</strong> <span id="pi_bed_status"></span></p>
            <p><strong>Bed type:</strong> <span id="pi_bed_type"></span></p>
            <p><strong>Ward:</strong> <span id="pi_ward"></span></p>
          </div>
        </div>
      </section>
    </main>

    <!-- =========================
         SCRIPTS
         ========================= -->
    <script>
      const API_BASE = "https://ingest-service-725327609427.us-east5.run.app";

      const WARD_LABELS = {
        1: "ICU North",
        2: "General East",
        3: "Isolation South",
      };

      let ALL_BEDS = [];

      function setToday() {
        const el = document.getElementById("todayValue");
        const now = new Date();
        el.textContent = now.toLocaleString("en-US", {
          month: "short",
          day: "numeric",
        });
      }

      async function loadBeds() {
  try {
    const res = await fetch(`${API_BASE}/beds`);
    const beds = await res.json();
    ALL_BEDS = beds || [];

    const select = document.getElementById("bedSelect");
    select.innerHTML = "";

    beds.forEach((b) => {
      const opt = document.createElement("option");
      opt.value = b.bed_number;

      // Label shown in dropdown
      opt.textContent = `${b.bed_number} — ${b.bed_status}`;

      // Color class for readability
      opt.classList.add(`bed-option-${b.bed_status}`);

      select.appendChild(opt);
    });

    // Auto-load info for first bed
    if (beds.length > 0) {
      loadBedInfo(beds[0].bed_number);
      loadPatientInfo(beds[0].bed_number);
    }

    // Event: When user selects a different bed
    select.addEventListener("change", (e) => {
      const bedNum = e.target.value;
      loadBedInfo(bedNum);
      loadPatientInfo(bedNum);
    });

    // Update ward summary cards
    updateOverviewCards();

  } catch (err) {
    console.error("Error loading beds:", err);
    document.getElementById("bedSelect").innerHTML =
      "<option>Failed to load beds</option>";
  }
}


      function updateOverviewCards() {
        const totalBeds = ALL_BEDS.length;

        const counts = {
          available: 0,
          occupied: 0,
          reserved: 0,
          cleaning: 0,
          transferring: 0,
        };

        ALL_BEDS.forEach((b) => {
          if (counts[b.bed_status] !== undefined) counts[b.bed_status]++;
        });

        const inUse = counts.occupied + counts.transferring;
        const pct = totalBeds ? Math.round((inUse / totalBeds) * 100) : 0;

        document.getElementById("overallTotalBeds").textContent = totalBeds;
        document.getElementById("overallOccupiedBeds").textContent = inUse;
        document.getElementById("overallOccupancyPercent").textContent = pct;

        document.getElementById("countAvailable").textContent = counts.available;
        document.getElementById("countOccupied").textContent = counts.occupied;
        document.getElementById("countReserved").textContent = counts.reserved;
        document.getElementById("countCleaning").textContent = counts.cleaning;
        document.getElementById("countTransferring").textContent = counts.transferring;

        const wardStats = {};
        ALL_BEDS.forEach((b) => {
          const wid = b.ward_id;
          if (!wardStats[wid]) {
            wardStats[wid] = {
              total: 0,
              occupied: 0,
              available: 0,
              reserved: 0,
              cleaning: 0,
              transferring: 0,
            };
          }
          wardStats[wid].total++;
          if (wardStats[wid][b.bed_status] !== undefined) {
            wardStats[wid][b.bed_status]++;
          }
        });

        ["1", "2", "3"].forEach((wid) => {
          const s =
            wardStats[wid] || {
              total: 0,
              occupied: 0,
              available: 0,
              reserved: 0,
              cleaning: 0,
              transferring: 0,
            };
          document.getElementById(`ward-${wid}-total`).textContent = s.total;
          document.getElementById(`ward-${wid}-inuse`).textContent =
            s.occupied + s.transferring;
          document.getElementById(`ward-${wid}-available`).textContent = s.available;
        });
      }

      async function loadBedInfo(bedNumber) {
        try {
          const res = await fetch(`${API_BASE}/beds/${bedNumber}`);
          if (!res.ok) return;
          const data = await res.json();

          const box = document.getElementById("bedInfoBox");
          const content = document.getElementById("bedInfoContent");

          box.style.display = "block";
          content.innerHTML = `
            <strong>Bed number:</strong> ${data.bed_number}<br>
            <strong>Status:</strong> ${data.bed_status}<br>
            <strong>Type:</strong> ${data.bed_type}<br>
            <strong>Ward:</strong> ${data.ward_name} (Floor ${data.floor_number})<br>
            <strong>Patient assigned:</strong> ${data.patient_id ?? "None"}
          `;
        } catch (err) {
          console.error("Error loading bed info:", err);
        }
      }

      async function loadPatientInfo(bedNumber) {
        const box = document.getElementById("patientInfo");

        try {
          const res = await fetch(`${API_BASE}/beds/${bedNumber}`);
          if (!res.ok) {
            box.style.display = "none";
            return;
          }

          const d = await res.json();

          document.getElementById("pi_id").textContent = d.patient_id ?? "None";
          document.getElementById("pi_name").textContent = d.first_name
            ? `${d.first_name} ${d.last_name}`
            : "No patient assigned";
          document.getElementById("pi_status").textContent =
            d.admission_status ?? "N/A";
          document.getElementById("pi_bed_status").textContent = d.bed_status;
          document.getElementById("pi_bed_type").textContent = d.bed_type;
          document.getElementById("pi_ward").textContent = d.ward_name;

          box.style.display = "block";
        } catch (err) {
          console.error("Error loading patient info:", err);
          box.style.display = "none";
        }
      }

      async function updateBed() {
  const selected = document.getElementById("bedSelect").value;
  const new_status = document.getElementById("statusSelect").value;
  const patient_id_raw = document.getElementById("patientIdInput").value.trim();

  if (!selected) {
    alert("Please select a bed first.");
    return;
  }

  // Extract "A101" cleanly
  const bed_number = selected.split(" ")[0];

  let patient_id = null;

  if (new_status === "occupied") {
    if (!patient_id_raw) {
      alert("You must enter a patient ID for an occupied bed.");
      return;
    }
    patient_id = parseInt(patient_id_raw, 10);
  }

  try {
    const res = await fetch(`${API_BASE}/beds/update`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        bed_number,
        bed_status: new_status,
        patient_id
      }),
    });

    const text = await res.text();
    if (!res.ok) {
      alert(text);
      return;
    }

    alert("Bed updated successfully!");
    loadBeds();
    loadBedInfo(bed_number);
    loadPatientInfo(bed_number);

  } catch (err) {
    console.error(err);
    alert("Error updating bed.");
  }
}



      window.addEventListener("load", () => {
        setToday();
        loadBeds();
      });
    </script>

    <!-- === FIREBASE USER DISPLAY === -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
      import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCCv10iytVHPyRSB4dAotE2UBCRqr2sJ-8",
        authDomain: "sqldatabasetest-473020.firebaseapp.com",
        projectId: "sqldatabasetest-473020",
        storageBucket: "sqldatabasetest-473020.appspot.com",
        messagingSenderId: "725327609427",
        appId: "1:725327609427:web:989af1506e170afc0650a6",
        measurementId: "G-WCZ3JSGH71"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "../index.html";
          return;
        }

        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);

        if (!snap.exists()) return;

        const data = snap.data();

        document.getElementById("userName").textContent = data.fullName;
        document.getElementById("userRole").textContent = data.role;

        const initials = data.fullName
          .split(" ")
          .map((n) => n[0])
          .join("");

        document.getElementById("userInitials").textContent = initials;
      });
    </script>
  </body>
</html>
