<!DOCTYPE html> 
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Medbed Systems Dashboard</title>

    <!-- shared styles -->
    <link rel="stylesheet" href="../shared/variables.css" />
    <link rel="stylesheet" href="../shared/layout.css" />
    <link rel="stylesheet" href="../shared/components.css" />
    <!-- page-specific -->
    <link rel="stylesheet" href="dashboard.css" />
  </head>

  <body class="dashboard-page">
    <!-- =========================
         SIDEBAR
         ========================= -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <img src="../images/Med.jpg" alt="Medbed Systems logo" class="brand-logo" />
          <div class="logo-text">
            <span>Medbed Systems</span>
          </div>
        </div>

        <div class="sidebar-user">
          <div class="avatar-circle">JS</div>
          <div class="user-meta">
            <span class="user-name">John Smith</span>
            <span class="user-role">Doctor</span>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <p class="sidebar-label">Overview</p>
        <a href="dashboard.html" class="active">Dashboard</a>
        <a href="insights.html">Insights</a>

        <p class="sidebar-label">Operations</p>
        <a href="../operations/patients.html">Patients</a>
        <a href="../operations/manage-beds.html">Manage beds</a>
        <a href="../operations/manage-rooms.html">Manage rooms</a>
        <a href="../operations/users.html">Users</a>

        <a href="../shared/login.html" class="logout-link">Logout</a>
      </nav>
    </aside>

    <!-- =========================
         MAIN CONTENT
         ========================= -->
    <main class="dashboard-content">
      <header class="topbar">
        <div></div>
        <div class="topbar-pill">
          <span class="pill-label">Today</span>
          <span class="pill-value" id="todayValue">—</span>
        </div>
      </header>

      <section class="page-header">
        <h2>Hospital bed overview</h2>
        <p class="page-subtitle">
          View real-time occupancy across all wards, and update the status of individual beds.
        </p>
      </section>

      <!-- TOP ROW: OCCUPANCY + GRAFANA PLACEHOLDER -->
      <section class="top-row">
        <!-- LEFT: OCCUPANCY -->
        <div class="card occupancy-card">
          <h3>Occupancy</h3>

          <p class="big-number">
            <span id="overallOccupancyPercent">—</span><span class="big-number-unit">%</span>
          </p>

          <p class="muted">
            <span id="overallOccupiedBeds">—</span> of
            <span id="overallTotalBeds">—</span> beds in use
          </p>

          <hr class="card-divider" />

          <div class="status-header">Bed status</div>
          <ul class="status-list inline-status">
            <li>
              <span class="status-label status-available">Available</span>
              <span class="status-value" id="countAvailable">—</span>
            </li>
            <li>
              <span class="status-label status-occupied">Occupied</span>
              <span class="status-value" id="countOccupied">—</span>
            </li>
            <li>
              <span class="status-label status-reserved">Reserved</span>
              <span class="status-value" id="countReserved">—</span>
            </li>
            <li>
              <span class="status-label status-cleaning">Cleaning</span>
              <span class="status-value" id="countCleaning">—</span>
            </li>
            <li>
              <span class="status-label status-transferring">Transferring</span>
              <span class="status-value" id="countTransferring">—</span>
            </li>
          </ul>
        </div>

        <!-- RIGHT: GRAFANA PLACEHOLDER -->
        <div class="card placeholder-card">
          <h3>New admissions</h3>
          <p class="muted">Reserved space for Grafana admissions chart.</p>
          <div class="placeholder-area"></div>
        </div>
      </section>

      <!-- MIDDLE ROW: 3 WARD CARDS -->
      <section class="page-section">
        <div class="section-header">
          <h3>Wards overview</h3>
          <p class="muted">Current occupancy by ward.</p>
        </div>

        <div class="wards-row">
          <div class="card ward-card">
            <h4 id="ward-1-name">ICU North</h4>
            <p><span id="ward-1-total">—</span> beds</p>
            <p><span id="ward-1-inuse">—</span> in use</p>
            <p><span id="ward-1-available">—</span> available</p>
          </div>

          <div class="card ward-card">
            <h4 id="ward-2-name">General East</h4>
            <p><span id="ward-2-total">—</span> beds</p>
            <p><span id="ward-2-inuse">—</span> in use</p>
            <p><span id="ward-2-available">—</span> available</p>
          </div>

          <div class="card ward-card">
            <h4 id="ward-3-name">Isolation South</h4>
            <p><span id="ward-3-total">—</span> beds</p>
            <p><span id="ward-3-inuse">—</span> in use</p>
            <p><span id="ward-3-available">—</span> available</p>
          </div>
        </div>
      </section>

      <!-- UPDATE BED + DETAILS -->
      <section class="card">
        <h3>Update bed status</h3>
        <p class="muted">
          Choose a bed and update its current status.
        </p>

        <div class="filters-row">
          <select id="bedSelect" class="input-select">
            <option>Loading beds…</option>
          </select>

          <select id="statusSelect" class="input-select">
            <option value="available">Available</option>
            <option value="occupied">Occupied</option>
            <option value="reserved">Reserved</option>
            <option value="cleaning">Cleaning</option>
            <option value="transferring">Transferring</option>
          </select>

          <button class="small-btn" type="button" onclick="updateBed()">Update bed</button>
        </div>
      </section>

      <section class="top-row">
        <div class="card">
          <h3>Bed details</h3>
          <div id="bedInfoBox" style="display:none; margin-top: 10px; font-size: 13px;">
            <p id="bedInfoContent"></p>
          </div>
        </div>

        <div class="card">
          <h3>Patient details</h3>
          <div id="patientInfo" style="display:none; margin-top: 10px; font-size: 13px;">
            <p><strong>Patient ID:</strong> <span id="pi_id"></span></p>
            <p><strong>Name:</strong> <span id="pi_name"></span></p>
            <p><strong>Admission status:</strong> <span id="pi_status"></span></p>
            <p><strong>Bed status:</strong> <span id="pi_bed_status"></span></p>
            <p><strong>Bed type:</strong> <span id="pi_bed_type"></span></p>
            <p><strong>Ward:</strong> <span id="pi_ward"></span></p>
          </div>
        </div>
      </section>
    </main>

    <!-- =========================
         SCRIPTS
         ========================= -->
    <script>
      const API_BASE = "https://ingest-service-725327609427.us-east5.run.app";

      const WARD_LABELS = {
        1: "ICU North",
        2: "General East",
        3: "Isolation South",
      };

      let ALL_BEDS = [];

      function setToday() {
        const el = document.getElementById("todayValue");
        const now = new Date();
        el.textContent = now.toLocaleString("en-US", { month: "short", day: "numeric" });
      }

      async function loadBeds() {
        try {
          const res = await fetch(`${API_BASE}/beds`);
          const beds = await res.json();
          ALL_BEDS = beds || [];

          const select = document.getElementById("bedSelect");
          select.innerHTML = "";

          ALL_BEDS.forEach((b) => {
            const opt = document.createElement("option");
            opt.value = b.bed_number;
            const wardLabel = WARD_LABELS[b.ward_id] || `Ward ${b.ward_id}`;
            opt.textContent = `Bed ${b.bed_number} (${wardLabel})`;
            select.appendChild(opt);
          });

          if (ALL_BEDS.length > 0) {
            const first = ALL_BEDS[0].bed_number;
            loadBedInfo(first);
            loadPatientInfo(first);
          }

          updateOverviewCards();

          select.addEventListener("change", (e) => {
            const bedNum = e.target.value;
            loadBedInfo(bedNum);
            loadPatientInfo(bedNum);
          });
        } catch (err) {
          console.error("Error loading beds:", err);
          const select = document.getElementById("bedSelect");
          select.innerHTML = "<option>Failed to load beds</option>";
        }
      }

      function updateOverviewCards() {
        const totalBeds = ALL_BEDS.length;
        const counts = {
          available: 0,
          occupied: 0,
          reserved: 0,
          cleaning: 0,
          transferring: 0,
        };

        ALL_BEDS.forEach((b) => {
          if (counts[b.bed_status] !== undefined) {
            counts[b.bed_status] += 1;
          }
        });

        const bedsInUse = counts.occupied + counts.transferring;
        const occupancyPct = totalBeds ? Math.round((bedsInUse / totalBeds) * 100) : 0;

        document.getElementById("overallTotalBeds").textContent = totalBeds;
        document.getElementById("overallOccupiedBeds").textContent = bedsInUse;
        document.getElementById("overallOccupancyPercent").textContent = occupancyPct;

        document.getElementById("countAvailable").textContent = counts.available;
        document.getElementById("countOccupied").textContent = counts.occupied;
        document.getElementById("countReserved").textContent = counts.reserved;
        document.getElementById("countCleaning").textContent = counts.cleaning;
        document.getElementById("countTransferring").textContent = counts.transferring;

        const wardStats = {};

        ALL_BEDS.forEach((b) => {
          const wid = b.ward_id;
          if (!wardStats[wid]) {
            wardStats[wid] = {
              total: 0,
              occupied: 0,
              available: 0,
              reserved: 0,
              cleaning: 0,
              transferring: 0,
            };
          }
          wardStats[wid].total += 1;
          if (wardStats[wid][b.bed_status] !== undefined) {
            wardStats[wid][b.bed_status] += 1;
          }
        });

        ["1", "2", "3"].forEach((wid) => {
          const stats =
            wardStats[wid] || {
              total: 0,
              occupied: 0,
              available: 0,
              reserved: 0,
              cleaning: 0,
              transferring: 0,
            };

          const inUse = stats.occupied + stats.transferring;
          const available = stats.available;
          const total = stats.total;

          const nameEl = document.getElementById(`ward-${wid}-name`);
          const totalEl = document.getElementById(`ward-${wid}-total`);
          const inUseEl = document.getElementById(`ward-${wid}-inuse`);
          const availEl = document.getElementById(`ward-${wid}-available`);

          if (nameEl) nameEl.textContent = WARD_LABELS[wid] || `Ward ${wid}`;
          if (totalEl) totalEl.textContent = total;
          if (inUseEl) inUseEl.textContent = inUse;
          if (availEl) availEl.textContent = available;
        });
      }

      async function loadBedInfo(bedNumber) {
        if (!bedNumber) return;
        try {
          const res = await fetch(`${API_BASE}/beds/${bedNumber}`);
          const data = await res.json();

          const box = document.getElementById("bedInfoBox");
          const content = document.getElementById("bedInfoContent");

          box.style.display = "block";
          content.innerHTML = `
            <strong>Bed number:</strong> ${data.bed_number}<br>
            <strong>Status:</strong> ${data.bed_status}<br>
            <strong>Type:</strong> ${data.bed_type}<br>
            <strong>Ward:</strong> ${data.ward_name} (Floor ${data.floor_number})<br>
            <strong>Patient assigned:</strong> ${data.patient_id ?? "None"}
          `;
        } catch (err) {
          console.error("Error loading bed info:", err);
        }
      }

      async function loadPatientInfo(bedNumber) {
        const patientBox = document.getElementById("patientInfo");
        if (!bedNumber) {
          patientBox.style.display = "none";
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/beds/${bedNumber}`);
          if (!res.ok) {
            patientBox.style.display = "none";
            return;
          }

          const data = await res.json();

          document.getElementById("pi_id").textContent = data.patient_id ?? "None";
          document.getElementById("pi_name").textContent = data.first_name
            ? `${data.first_name} ${data.last_name}`
            : "No patient assigned";
          document.getElementById("pi_status").textContent = data.admission_status ?? "N/A";
          document.getElementById("pi_bed_status").textContent = data.bed_status;
          document.getElementById("pi_bed_type").textContent = data.bed_type;
          document.getElementById("pi_ward").textContent = data.ward_name;

          patientBox.style.display = "block";
        } catch (err) {
          console.error("Error loading patient info:", err);
          patientBox.style.display = "none";
        }
      }

      async function updateBed() {
        const bedNumber = document.getElementById("bedSelect").value;
        const new_status = document.getElementById("statusSelect").value;

        if (!bedNumber) {
          alert("Please select a bed first.");
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/beds/update`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              bed_id: bedNumber,
              bed_status: new_status,
              patient_id: null,
            }),
          });

          const text = await res.text();
          alert(text);

          loadBedInfo(bedNumber);
          loadPatientInfo(bedNumber);
          loadBeds();
        } catch (err) {
          console.error("Error updating bed:", err);
          alert("Failed to update bed.");
        }
      }

      window.addEventListener("load", () => {
        setToday();
        loadBeds();
      });
    </script>
  </body>
</html>
