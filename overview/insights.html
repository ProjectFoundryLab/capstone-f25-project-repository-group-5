<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Insights – Medbed Systems</title>

    <!-- shared styles -->
    <link rel="stylesheet" href="../shared/variables.css" />
    <link rel="stylesheet" href="../shared/layout.css" />
    <link rel="stylesheet" href="../shared/components.css" />
    <!-- page-specific -->
    <link rel="stylesheet" href="insights.css" />
  </head>

  <body class="dashboard-page">
    <!-- ============= SIDEBAR ============= -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <img src="../images/Med.jpg" alt="Medbed Systems logo" class="brand-logo" />
          <div class="logo-text"><span>Medbed Systems</span></div>
        </div>

        <div class="sidebar-user">
          <div class="avatar-circle" id="userInitials">JS</div>
          <div class="user-meta">
            <span class="user-name" id="userName">Loading...</span>
            <span class="user-role" id="userRole">Role...</span>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <p class="sidebar-label">Overview</p>
        <a href="dashboard.html">Dashboard</a>
        <a href="insights.html" class="active">Insights</a>

        <p class="sidebar-label">Operations</p>
        <a href="../operations/patients.html">Patients</a>
        <a href="../operations/manage-beds.html">Manage beds</a>
        <a href="../operations/manage-rooms.html">Manage rooms</a>

        <a href="../index.html" class="logout-link">Logout</a>
      </nav>
    </aside>

    <!-- ============= MAIN CONTENT ============= -->
    <main class="dashboard-content">
      <header class="topbar">
        <div></div>
        <div class="topbar-pill">
          <span class="pill-label">Today</span>
          <span class="pill-value" id="todayValue">—</span>
        </div>
      </header>

      <section class="page-header">
        <h2>Insights</h2>
        <p class="page-subtitle">
          Predictive-style analytics for occupancy and patient trends using the current hospital data.
        </p>
      </section>

      <!-- TOP: SUMMARY CARDS -->
      <section class="insights-summary-row">
        <div class="card insight-card">
          <h3>Current occupancy</h3>
          <p class="big-number">
            <span id="occupancyPercent">—</span><span class="big-number-unit">%</span>
          </p>
          <p class="muted" id="occupancyDetail"></p>
        </div>

        <div class="card insight-card">
          <h3>Busiest ward right now</h3>
          <p class="big-number"><span id="busiestWard">—</span></p>
          <p class="muted" id="busiestWardDetail"></p>
        </div>

        <div class="card insight-card">
          <h3>COVID-19 case share</h3>
          <p class="big-number">
            <span id="covidPercent">—</span><span class="big-number-unit">%</span>
          </p>
          <p class="muted" id="covidDetail"></p>
        </div>
      </section>

      <!-- CHARTS: STACKED VERTICALLY -->
      <section class="insights-chart-row">
        <!-- Chart 1: Medical Condition -->
        <div class="card chart-card">
          <div class="chart-placeholder">
            <iframe
              src="https://lookerstudio.google.com/embed/reporting/6e261ff2-c6fa-45c8-8a08-9237021c09ca/page/p_4bfcvmgdyd"
              width="100%"
              height="100%"
              frameborder="0"
              style="border:0;"
              allowfullscreen
              sandbox="allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox">
            </iframe>
          </div>
        </div>

        <!-- Chart 2: Trendline Forecast -->
        <div class="card chart-card">
          <div class="chart-placeholder">
            <iframe
              src="https://lookerstudio.google.com/embed/reporting/6e261ff2-c6fa-45c8-8a08-9237021c09ca/page/p_00xkukhdyd"
              width="100%"
              height="100%"
              frameborder="0"
              style="border:0;"
              allowfullscreen
              sandbox="allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox">
            </iframe>
          </div>
        </div>
      </section>
    </main>

    <!-- ============= PAGE LOGIC ============= -->
    <script>
      const API_BASE = "https://ingest-service-725327609427.us-east5.run.app";

      const WARD_LABELS = {
        1: "ICU North",
        2: "General East",
        3: "Isolation South",
      };

      function setTodayInsights() {
        const el = document.getElementById("todayValue");
        el.textContent = new Date().toLocaleString("en-US", {
          month: "short",
          day: "numeric",
        });
      }

      async function loadInsights() {
        try {
          const [bedsRes, admissionsRes] = await Promise.all([
            fetch(`${API_BASE}/beds`),
            fetch(`${API_BASE}/admissions/latest`)
          ]);

          const beds = bedsRes.ok ? await bedsRes.json() : [];
          const admissions = admissionsRes.ok ? await admissionsRes.json() : [];

          updateOccupancyCard(beds);
          updateBusiestWardCard(beds);
          updateCovidCard(admissions);
        } catch (err) {
          console.error("Error loading insights:", err);
        }
      }

      function updateOccupancyCard(beds) {
        const totalBeds = beds.length;
        const inUse = beds.filter(b =>
          ["occupied", "reserved", "cleaning", "transferring"].includes(
            (b.bed_status || "").toLowerCase()
          )
        ).length;
        const pct = totalBeds ? Math.round((inUse / totalBeds) * 100) : 0;

        document.getElementById("occupancyPercent").textContent = pct;
        document.getElementById("occupancyDetail").textContent =
          `${inUse} of ${totalBeds} beds currently in use.`;
      }

      function updateBusiestWardCard(beds) {
        const counts = {};
        beds.forEach(b => {
          const status = (b.bed_status || "").toLowerCase();
          if (["occupied", "reserved", "cleaning", "transferring"].includes(status)) {
            counts[b.ward_id] = (counts[b.ward_id] || 0) + 1;
          }
        });

        let ward = null, max = 0;
        Object.entries(counts).forEach(([id, count]) => {
          if (count > max) {
            max = count;
            ward = id;
          }
        });

        document.getElementById("busiestWard").textContent =
          ward ? WARD_LABELS[ward] : "No data";
        document.getElementById("busiestWardDetail").textContent =
          ward ? `${max} beds in use in this ward.` : "";
      }

      // COVID-19 card using /admissions/latest
      function updateCovidCard(admissions) {
        const percentEl = document.getElementById("covidPercent");
        const detailEl = document.getElementById("covidDetail");

        if (!Array.isArray(admissions) || admissions.length === 0) {
          percentEl.textContent = "—";
          detailEl.textContent = "No recent admissions available.";
          return;
        }

        const total = admissions.length;

        const covid = admissions.filter(a =>
          (a.admission_reason || "").toLowerCase() === "covid-19"
        ).length;

        const pct = total ? Math.round((covid / total) * 100) : 0;
        percentEl.textContent = pct;

        if (covid === 0) {
          detailEl.textContent =
            `0 of the last ${total} admissions were due to COVID-19. Recent trend shows no COVID-related admissions.`;
        } else {
          detailEl.textContent =
            `${covid} of the last ${total} admissions were due to COVID-19. Based on the most recent admissions feed.`;
        }
      }

      window.addEventListener("load", () => {
        setTodayInsights();
        loadInsights();
      });
    </script>

    <!-- FIREBASE / AUTH USER DISPLAY -->
    <script type="module">
      import { loadUserProfile, logout } from "../shared/auth.js";
      loadUserProfile().then(data => {
        document.getElementById("userName").textContent = data.fullName;
        document.getElementById("userRole").textContent = data.role;
        document.getElementById("userInitials").textContent =
          data.fullName.split(" ").map(x => x[0]).join("");
      });

      document.querySelector(".logout-link").addEventListener("click", (e) => {
        e.preventDefault();
        logout();
      });
    </script>
  </body>
</html>
