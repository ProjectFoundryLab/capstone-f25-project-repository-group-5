<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Medbed Systems – Patients</title>

  <!-- shared styles -->
  <link rel="stylesheet" href="../shared/variables.css" />
  <link rel="stylesheet" href="../shared/layout.css" />
  <link rel="stylesheet" href="../shared/components.css" />

  <!-- page-specific -->
  <link rel="stylesheet" href="patients.css" />
</head>

<body class="dashboard-page">
  <!-- ======================= SIDEBAR ======================= -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-brand">
        <img src="../images/Med.jpg" alt="Medbed Systems logo" class="brand-logo" />
        <div class="logo-text"><span>Medbed Systems</span></div>
      </div>

      <div class="sidebar-user">
        <div class="avatar-circle">JS</div>
        <div class="user-meta">
          <span class="user-name">John Smith</span>
          <span class="user-role">Doctor</span>
        </div>
      </div>
    </div>

    <nav class="sidebar-nav">
      <p class="sidebar-label">Overview</p>
      <a href="../overview/dashboard.html">Dashboard</a>
      <a href="../overview/insights.html">Insights</a>

      <p class="sidebar-label">Operations</p>
      <a href="patients.html" class="active">Patients</a>
      <a href="manage-beds.html">Manage beds</a>
      <a href="manage-rooms.html">Manage rooms</a>

      <a href="../shared/login.html" class="logout-link">Logout</a>
    </nav>
  </aside>

  <!-- ======================= MAIN CONTENT ======================= -->
  <main class="dashboard-content">
    <header class="topbar">
      <div></div>
      <div class="topbar-pill">
        <span class="pill-label">Today</span>
        <span class="pill-value" id="todayValue">—</span>
      </div>
    </header>

    <section class="page-header">
      <h2>Patients</h2>
      <p class="page-subtitle">Search and explore all patients in the hospital system.</p>
    </section>

    <section class="card patients-card">
      <!-- Search + filters -->
      <div class="patients-filters">
        <input type="text" id="searchInput" class="input-text patients-search"
               placeholder="Search by name or MRN" />

        <select id="statusFilter" class="input-select">
          <option value="all">All statuses</option>
          <option value="Admitted">Admitted</option>
          <option value="Discharged">Discharged</option>
          <option value="Transferred">Transferred</option>
          <option value="Pending">Pending</option>
        </select>

        <select id="reasonFilter" class="input-select">
          <option value="all">All reasons</option>
          <option value="COVID-19">COVID-19</option>
          <option value="Flu">Flu</option>
          <option value="Injury">Injury</option>
          <option value="Heart Attack">Heart Attack</option>
          <option value="Stroke">Stroke</option>
          <option value="Surgery">Surgery</option>
          <option value="Accident">Accident</option>
          <option value="Checkup">Checkup</option>
          <option value="Asthma">Asthma</option>
          <option value="Diabetes">Diabetes</option>
        </select>

        <button class="primary-btn" type="button" onclick="applyFilters()">Filter</button>
      </div>

      <!-- Table -->
      <div class="table-wrapper">
        <table class="data-table patients-table">
          <thead>
            <tr>
              <th>Patient</th>
              <th>MRN</th>
              <th>Status</th>
              <th>Priority</th>
              <th>Reason</th>
            </tr>
          </thead>
          <tbody id="patientsTableBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- ======================= DETAILS DRAWER ======================= -->
  <aside id="drawer" class="drawer">
    <div class="drawer-header">
      <h3>Patient Details</h3>
      <button class="drawer-close" onclick="closeDrawer()">×</button>
    </div>

    <div class="drawer-content">
      <p><strong>Name:</strong> <span id="d_name"></span></p>
      <p><strong>MRN:</strong> <span id="d_mrn"></span></p>
      <p><strong>Status:</strong> <span id="d_status"></span></p>
      <p><strong>Priority Level:</strong> <span id="d_priority"></span></p>
      <p><strong>Reason:</strong> <span id="d_reason"></span></p>
      <p><strong>Date of Birth:</strong> <span id="d_dob"></span></p>
      <p><strong>Gender:</strong> <span id="d_gender"></span></p>
      <p><strong>Patient ID:</strong> <span id="d_id"></span></p>
    </div>
  </aside>

  <!-- ======================= PAGE LOGIC ======================= -->
  <script>
    const API_BASE = "https://ingest-service-725327609427.us-east5.run.app";
    let ALL_PATIENTS = [];

    function setTodayPatients() {
      const el = document.getElementById("todayValue");
      const now = new Date();
      el.textContent = now.toLocaleString("en-US", { month: "short", day: "numeric" });
    }

    // Apply UI class for status pills
    function statusClass(status) {
      if (!status) return "status-pill";
      const s = status.toLowerCase();
      if (s === "admitted") return "status-pill status-pill-inuse";
      if (s === "discharged") return "status-pill status-pill-discharged";
      if (s === "pending") return "status-pill status-pill-reserved";
      if (s === "transferred") return "status-pill status-pill-cleaning";
      return "status-pill";
    }

    async function loadPatients() {
      try {
        const res = await fetch(`${API_BASE}/patients`);
        if (!res.ok) throw new Error("Failed to fetch patients");
        ALL_PATIENTS = await res.json();
        renderPatientsTable(ALL_PATIENTS);
      } catch (err) {
        console.error("Patient load error:", err);
        const tbody = document.getElementById("patientsTableBody");
        tbody.innerHTML = `<tr><td colspan="5" class="empty-row">Unable to load patients</td></tr>`;
      }
    }

    // Render the table rows
    function renderPatientsTable(list) {
      const tbody = document.getElementById("patientsTableBody");
      tbody.innerHTML = "";

      if (!list.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="empty-row">No matching patients</td></tr>`;
        return;
      }

      list.forEach((p) => {
        const tr = document.createElement("tr");
        tr.classList.add("clickable-row");
        tr.onclick = () => openDrawer(p);

        tr.innerHTML = `
          <td>${p.first_name} ${p.last_name}</td>
          <td>${p.medical_record_number}</td>
          <td><span class="${statusClass(p.admission_status)}">${p.admission_status}</span></td>
          <td>${p.priority_level}</td>
          <td>${p.admit_reason}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Drawer open
    function openDrawer(p) {
      document.getElementById("d_name").textContent = `${p.first_name} ${p.last_name}`;
      document.getElementById("d_mrn").textContent = p.medical_record_number;
      document.getElementById("d_status").textContent = p.admission_status;
      document.getElementById("d_priority").textContent = p.priority_level;
      document.getElementById("d_reason").textContent = p.admit_reason;
      document.getElementById("d_dob").textContent = p.date_of_birth;
      document.getElementById("d_gender").textContent = p.gender;
      document.getElementById("d_id").textContent = p.patient_id;

      document.getElementById("drawer").classList.add("open");
    }

    // Drawer close
    function closeDrawer() {
      document.getElementById("drawer").classList.remove("open");
    }

    // Filtering logic
    function applyFilters() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const status = document.getElementById("statusFilter").value;
      const reason = document.getElementById("reasonFilter").value;

      const filtered = ALL_PATIENTS.filter((p) => {
        const matchesText =
          p.first_name.toLowerCase().includes(search) ||
          p.last_name.toLowerCase().includes(search) ||
          (p.medical_record_number || "").toLowerCase().includes(search);

        const matchesStatus =
          status === "all" || p.admission_status === status;

        const matchesReason =
          reason === "all" || p.admit_reason === reason;

        return matchesText && matchesStatus && matchesReason;
      });

      renderPatientsTable(filtered);
    }

    window.onload = () => {
      setTodayPatients();
      loadPatients();
    };

    document.getElementById("searchInput").addEventListener("keyup", (e) => {
      if (e.key === "Enter") applyFilters();
    });
  </script>
</body>
</html>
