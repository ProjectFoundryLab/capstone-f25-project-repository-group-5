<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Beds – Medbed Systems</title>

  <!-- shared styles -->
  <link rel="stylesheet" href="../shared/variables.css" />
  <link rel="stylesheet" href="../shared/layout.css" />
  <link rel="stylesheet" href="../shared/components.css" />

  <!-- page-specific -->
  <link rel="stylesheet" href="manage-beds.css" />
</head>

<body class="dashboard-page">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-brand">
        <img src="../images/Med.jpg" class="brand-logo" alt="Medbed Systems logo" />
        <div class="logo-text"><span>Medbed Systems</span></div>
      </div>

      <div class="sidebar-user">
        <div class="avatar-circle" id="userInitials">JS</div>
        <div class="user-meta">
          <span class="user-name" id="userName">Loading...</span>
          <span class="user-role" id="userRole">Role...</span>
        </div>

    </div>

    <nav class="sidebar-nav">
      <p class="sidebar-label">Overview</p>
      <a href="../overview/dashboard.html">Dashboard</a>
      <a href="../overview/insights.html">Insights</a>

      <p class="sidebar-label">Operations</p>
      <a href="patients.html">Patients</a>
      <a href="manage-beds.html" class="active">Manage beds</a>
      <a href="manage-rooms.html">Manage rooms</a>

      <a href="index.html" class="logout-link">Logout</a>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="dashboard-content">
    <header class="topbar">
      <div></div>
      <div class="topbar-pill">
        <span class="pill-label">Today</span>
        <span class="pill-value" id="todayValue">—</span>
      </div>
    </header>

    <section class="page-header">
      <h2>Manage beds</h2>
      <p class="page-subtitle">
        View all beds, see which ward and room they belong to, and filter by status.
      </p>
    </section>

    <!-- FILTER BAR -->
    <section class="card beds-filter-card">
      <select class="input-select" id="filterWard">
        <option value="">All wards</option>
      </select>

      <select class="input-select" id="filterStatus">
        <option value="">All statuses</option>
        <option value="available">Available</option>
        <option value="occupied">Occupied</option>
        <option value="reserved">Reserved</option>
        <option value="cleaning">Cleaning</option>
        <option value="transferring">Transferring</option>
      </select>

      <button class="small-btn" id="applyFiltersBtn">Apply filters</button>
    </section>

    <!-- TABLE -->
    <section class="card">
      <div class="table-wrapper">
        <table class="data-table" id="bedsTable">
          <thead>
            <tr>
              <th>Bed</th>
              <th>Ward</th>
              <th>Room</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody id="bedsTbody">
            <tr><td colspan="5" class="empty-row">Loading beds…</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- PAGE LOGIC -->
  <script>
    const API_BASE = "https://ingest-service-725327609427.us-east5.run.app";
    let ALL_BEDS = [];

    function setToday() {
      const now = new Date();
      document.getElementById("todayValue").textContent =
        now.toLocaleDateString("en-US", { month: "short", day: "numeric" });
    }

    // Helper: derive room number from bed_number like "A101" -> "101"
    function getRoomNumberFromBed(bedNumber) {
      if (!bedNumber || typeof bedNumber !== "string") return "—";
      // assume first character is building letter, rest is room
      if (bedNumber.length > 1) {
        return bedNumber.substring(1);
      }
      return bedNumber;
    }

    async function loadBeds() {
      try {
        const res = await fetch(\`\${API_BASE}/beds\`);
        ALL_BEDS = await res.json();

        populateFilterOptions(ALL_BEDS);
        renderTable(ALL_BEDS);
      } catch (err) {
        console.error("Error loading beds:", err);
        const tbody = document.getElementById("bedsTbody");
        tbody.innerHTML = '<tr><td colspan="5" class="empty-row">Failed to load beds.</td></tr>';
      }
    }

    function populateFilterOptions(beds) {
      const wardSelect = document.getElementById("filterWard");

      // Extract unique ward names (fallback to "Ward X" if name missing)
      const wards = [...new Set(
        beds.map(b => b.ward_name || \`Ward \${b.ward_id}\`)
      )];

      wards.forEach(w => {
        const opt = document.createElement("option");
        opt.value = w;
        opt.textContent = w;
        wardSelect.appendChild(opt);
      });
    }

    function renderTable(beds) {
      const tbody = document.getElementById("bedsTbody");
      tbody.innerHTML = "";

      if (!beds.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-row">No beds found</td></tr>';
        return;
      }

      beds.forEach(b => {
        const row = document.createElement("tr");

        const wardName = b.ward_name || \`Ward \${b.ward_id}\`;
        const roomNumber = b.room_number || getRoomNumberFromBed(b.bed_number);

        row.innerHTML = \`
          <td>Bed \${b.bed_number}</td>
          <td>\${wardName}</td>
          <td>Room \${roomNumber}</td>
          <td>
            <span class="status-pill status-\${b.bed_status}">\${b.bed_status}</span>
          </td>
          <td class="actions-cell">
            <button class="table-btn green">Mark cleaning</button>
            <button class="table-btn navy">Discharge</button>
          </td>
        \`;

        tbody.appendChild(row);
      });
    }

    function applyFilters() {
      const ward = document.getElementById("filterWard").value;
      const status = document.getElementById("filterStatus").value;

      const filtered = ALL_BEDS.filter(b => {
        const wardName = b.ward_name || \`Ward \${b.ward_id}\`;
        const matchesWard = ward === "" || wardName === ward;
        const matchesStatus = status === "" || b.bed_status === status;
        return matchesWard && matchesStatus;
      });

      renderTable(filtered);
    }

    // Event listeners
    document.getElementById("applyFiltersBtn").onclick = applyFilters;

    window.onload = () => {
      setToday();
      loadBeds();
    };
  </script>

  <script type="module">
    import { loadUserProfile, logout } from "../shared/auth.js";

    loadUserProfile().then((data) => {
      document.getElementById("userName").textContent = data.fullName;
      document.getElementById("userRole").textContent = data.role;
      document.getElementById("userInitials").textContent =
        data.fullName.split(" ").map(n => n[0]).join("");
    });

    document.querySelector(".logout-link").addEventListener("click", (e) => {
      e.preventDefault();
      logout();
    });
  </script>

</body>
</html>
