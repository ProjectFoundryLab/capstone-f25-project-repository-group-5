<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Rooms – Medbed Systems</title>

    <!-- shared styles -->
    <link rel="stylesheet" href="../shared/variables.css" />
    <link rel="stylesheet" href="../shared/layout.css" />
    <link rel="stylesheet" href="../shared/components.css" />

    <!-- page-specific -->
    <link rel="stylesheet" href="manage-rooms.css" />
  </head>

  <body class="dashboard-page">
    <!-- ========== SIDEBAR ========== -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <img src="../images/Med.jpg" alt="Medbed Systems logo" class="brand-logo" />
          <div class="logo-text">
            <span>Medbed Systems</span>
          </div>
        </div>

        <div class="sidebar-user">
          <div class="avatar-circle" id="userInitials">JS</div>
          <div class="user-meta">
            <span class="user-name" id="userName">Loading...</span>
            <span class="user-role" id="userRole">Role...</span>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <p class="sidebar-label">Overview</p>
        <a href="../overview/dashboard.html">Dashboard</a>
        <a href="../overview/insights.html">Insights</a>

        <p class="sidebar-label">Operations</p>
        <a href="patients.html">Patients</a>
        <a href="manage-beds.html">Manage beds</a>
        <a href="manage-rooms.html" class="active">Manage rooms</a>

        <a href="../index.html" class="logout-link">Logout</a>
      </nav>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="dashboard-content">
      <header class="topbar">
        <div></div>
        <div class="topbar-pill">
          <span class="pill-label">Today</span>
          <span class="pill-value" id="todayValue">—</span>
        </div>
      </header>

      <section class="page-header">
        <h2>Manage rooms</h2>
        <p class="page-subtitle">
          Browse all rooms by ward, building, and floor.
        </p>
      </section>

      <!-- FILTER BAR -->
      <section class="card rooms-filter-card">
        <select class="input-select" id="filterWard">
          <option value="">All wards</option>
        </select>

        <select class="input-select" id="filterBuilding">
          <option value="">All buildings</option>
        </select>

        <select class="input-select" id="filterFloor">
          <option value="">All floors</option>
        </select>

        <button class="small-btn" id="applyFiltersBtn">Apply filters</button>
      </section>

      <!-- ROOMS TABLE -->
      <section class="card rooms-table-card">
        <div class="table-wrapper">
          <table class="data-table" id="roomsTable">
            <thead>
              <tr>
                <th>Room</th>
                <th>Ward</th>
                <th>Building</th>
                <th>Floor</th>
                <th>Beds</th>
              </tr>
            </thead>
            <tbody id="roomsTbody">
              <tr>
                <td colspan="5" class="empty-row">
                  Loading rooms…
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <!-- ========== PAGE LOGIC ========== -->
    <script>
      const API_BASE = "https://ingest-service-725327609427.us-east5.run.app";
      let ALL_ROOMS = [];

      function setTodayRooms() {
        const el = document.getElementById("todayValue");
        if (!el) return;
        const now = new Date();
        el.textContent = now.toLocaleString("en-US", {
          month: "short",
          day: "numeric",
        });
      }

      // derive room number from bed_number like "A101" -> "101"
      function getRoomNumberFromBed(bedNumber) {
        if (!bedNumber || typeof bedNumber !== "string") return "—";
        if (bedNumber.length > 1) {
          return bedNumber.substring(1);
        }
        return bedNumber;
      }

      async function loadRooms() {
        const tbody = document.getElementById("roomsTbody");
        try {
          // use beds + wards (this was your working pattern)
          const [bedsRes, wardsRes] = await Promise.all([
            fetch(`${API_BASE}/beds`),
            fetch(`${API_BASE}/wards`),
          ]);

          if (!bedsRes.ok || !wardsRes.ok) {
            throw new Error("Failed to load beds or wards");
          }

          const beds = await bedsRes.json();
          const wards = await wardsRes.json();

          // build map ward_id -> ward info
          const wardMap = {};
          wards.forEach((w) => {
            wardMap[w.ward_id] = w;
          });

          // build room summary from beds
          const roomMap = {};
          beds.forEach((b) => {
            const roomNumber = getRoomNumberFromBed(b.bed_number);
            const ward = wardMap[b.ward_id] || {};
            const key = `${b.ward_id || "none"}:${roomNumber}`;

            if (!roomMap[key]) {
              roomMap[key] = {
                room_number: roomNumber,
                ward_id: b.ward_id,
                ward_name: ward.name || `Ward ${b.ward_id ?? "—"}`,
                building: ward.building || "—",
                floor_number:
                  ward.floor_number !== undefined && ward.floor_number !== null
                    ? ward.floor_number
                    : "—",
                num_beds: 0,
              };
            }

            roomMap[key].num_beds += 1;
          });

          ALL_ROOMS = Object.values(roomMap);

          populateRoomFilters(ALL_ROOMS);
          renderRoomsTable(ALL_ROOMS);
        } catch (err) {
          console.error("Error loading rooms:", err);
          if (tbody) {
            tbody.innerHTML = `
              <tr>
                <td colspan="5" class="empty-row">
                  Unable to load rooms from backend.
                </td>
              </tr>
            `;
          }
        }
      }

      function populateRoomFilters(rooms) {
        const wardSelect = document.getElementById("filterWard");
        const buildingSelect = document.getElementById("filterBuilding");
        const floorSelect = document.getElementById("filterFloor");

        if (!wardSelect || !buildingSelect || !floorSelect) return;

        wardSelect.innerHTML = '<option value="">All wards</option>';
        buildingSelect.innerHTML = '<option value="">All buildings</option>';
        floorSelect.innerHTML = '<option value="">All floors</option>';

        const wardSet = new Set();
        const buildingSet = new Set();
        const floorSet = new Set();

        rooms.forEach((r) => {
          if (r.ward_name) wardSet.add(r.ward_name);
          if (r.building && r.building !== "—") buildingSet.add(r.building);
          if (r.floor_number !== "—") floorSet.add(r.floor_number);
        });

        Array.from(wardSet)
          .sort()
          .forEach((w) => {
            const opt = document.createElement("option");
            opt.value = w;
            opt.textContent = w;
            wardSelect.appendChild(opt);
          });

        Array.from(buildingSet)
          .sort()
          .forEach((b) => {
            const opt = document.createElement("option");
            opt.value = b;
            opt.textContent = b;
            buildingSelect.appendChild(opt);
          });

        Array.from(floorSet)
          .sort((a, b) => a - b)
          .forEach((f) => {
            const opt = document.createElement("option");
            opt.value = f;
            opt.textContent = f;
            floorSelect.appendChild(opt);
          });
      }

      function renderRoomsTable(rooms) {
        const tbody = document.getElementById("roomsTbody");
        if (!tbody) return;

        tbody.innerHTML = "";

        if (!rooms || rooms.length === 0) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 5;
          cell.className = "empty-row";
          cell.textContent = "No rooms match the current filters.";
          row.appendChild(cell);
          tbody.appendChild(row);
          return;
        }

        rooms.forEach((r) => {
          const row = document.createElement("tr");

          row.innerHTML = `
            <td>Room ${r.room_number}</td>
            <td>${r.ward_name}</td>
            <td>${r.building}</td>
            <td>${r.floor_number}</td>
            <td>${r.num_beds}</td>
          `;

          tbody.appendChild(row);
        });
      }

      function applyRoomFilters() {
        const wardVal = document.getElementById("filterWard").value;
        const buildingVal = document.getElementById("filterBuilding").value;
        const floorVal = document.getElementById("filterFloor").value;

        const filtered = ALL_ROOMS.filter((r) => {
          const matchesWard = !wardVal || r.ward_name === wardVal;
          const matchesBuilding = !buildingVal || r.building === buildingVal;
          const matchesFloor =
            !floorVal ||
            (r.floor_number !== "—" &&
              String(r.floor_number) === String(floorVal));

          return matchesWard && matchesBuilding && matchesFloor;
        });

        renderRoomsTable(filtered);
      }

      window.addEventListener("load", () => {
        setTodayRooms();
        loadRooms();

        const btn = document.getElementById("applyFiltersBtn");
        if (btn) btn.addEventListener("click", applyRoomFilters);
      });
    </script>

    <script type="module">
      import { loadUserProfile, logout } from "../shared/auth.js";

      loadUserProfile().then((data) => {
        document.getElementById("userName").textContent = data.fullName;
        document.getElementById("userRole").textContent = data.role;
        document.getElementById("userInitials").textContent =
          data.fullName.split(" ").map((n) => n[0]).join("");
      });

      document.querySelector(".logout-link").addEventListener("click", (e) => {
        e.preventDefault();
        logout();
      });
    </script>
  </body>
</html>
